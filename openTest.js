const playwright = require('playwright');
const fs = require('fs');

(async () => {
    const browser = await playwright["chromium"].launch({ headless: false, slowMo: 50 });
    const context = await browser.newContext();
    const page = await context.newPage();

    await page.goto('http://linkedin.com/');

    await page.click('xpath=//a[text()="Sign in"]');
    await page.click('//input[@type="text"]');
    await page.fill('//input[@type="text"]', 'harireddy05@gmail.com');
    await page.click('//input[@type="password"]');
    await page.fill('//input[@type="password"]', 'condescend');
    await page.keyboard.press('Enter');

    // await page.click('//header[@class="msg-overlay-bubble-header"]');

    try {
        // await page.click('//a[@href="/jobs/"]');        
        await page.click('//a[@data-test-global-nav-link="jobs"]');
    } catch (e) {
        await page.goto('https://www.linkedin.com/jobs/');
    }

    await page.click('//input[starts-with(@id, "jobs-search-box-keyword")]');
    await page.fill('//input[starts-with(@id, "jobs-search-box-keyword")]', 'reactjs developer');
    await page.click('//input[starts-with(@id, "jobs-search-box-location")]');
    await page.fill('//input[starts-with(@id, "jobs-search-box-location")]', 'california');
    await page.keyboard.press('Enter');

    await page.focus('//button[starts-with(@aria-label, "LinkedIn Features filter")]');
    await page.click('//button[starts-with(@aria-label, "LinkedIn Features filter")]');
    await page.click('//span[text()="Easy Apply"]');
    await page.keyboard.press('Enter');

    const resultCountEA = await page.innerText('//small[starts-with(@class, "display-flex")]');
    fs.writeFile('Report\\report.txt', `LinkedIn Job Application Report\n\nEasy Apply Search Return: ${resultCountEA} results.`, function (err) {
        if (err) return console.error(err);
        console.log(`Easy Apply search returned ${resultCountEA}. Added to report file.`);
    });

    const resultPages = await page.$$('//li[starts-with(@class, "artdeco-pagination")]');
    fs.appendFile('Report\\report.txt', `\nTotal Easy Apply Result Pages: ${resultPages.length} pages.`, function (err) {
        if (err) return console.error(err);
        console.log(`There are ${resultPages.length} page results. Added to report file.`);
    });

    const positionsList = []
    for (let i = 0; i < resultPages.length; i++) {
        await page.click(`//button[starts-with(@aria-label, "Page ${i + 1}")]`);
        const positions = await page.$$('//a[@data-test-job-card-list__title-link="true"]');
        positions.forEach(async (element) => {
            const text = await element.innerText();
            positionsList.push(text);
        });


        /* const company = await page.$$(`//a[@data-control-name="job_card_company_link"]`);
        company.forEach(async (element) => {
            const text = await element.innerText();
            companyList.push(text);
        }); */

        /* fs.appendFile('Report\\report.txt', `\n\nCompany List Found:\n\n` + `${companyList}`, function (err) {
            if (err) return console.error(err);
            console.log(companyList);
        }); */
    }
    console.log(positionsList)

    await page.screenshot({ path: `D:\\Projects\\test\\example.png` });
    await browser.close();

})();